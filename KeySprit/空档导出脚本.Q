[General]
SyntaxVersion=2
BeginHotkey=121
BeginHotkeyMod=0
PauseHotkey=19
PauseHotkeyMod=0
StopHotkey=123
StopHotkeyMod=0
RunOnce=1
EnableWindow=
MacroID=f9201074-565e-46df-a379-f952f22fb76e
Description=空档导出脚本
Enable=1
AutoRun=0
[Repeat]
Type=0
Number=1
[SetupUI]
Type=1
QUI=Form1
[Relative]
SetupOCXFile=
[Comment]

[UIPackage]
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


[Script]
Event Form1.Button1.Click
	Form1.InputBox1.Text = now()
End Event

Event Form1.LoadOver()
	Call 日志记录("***************程序启动***************")
End Event

Event Form1.UnLoad()
	Call 日志记录("***************程序结束***************")
End Event

Event Form1.Button2.Click
	Call 日志记录("**********" & form1.InputBox1.text & "*********" )

	If Plugin.SQLServer.Connect("172.16.1.2,1433", "sa", "Aa12345", "A3") = False Then //连接数据库 
		MessageBox Plugin.SQLServer.GetLastError()
		EndScript 
	End If
	Call 日志记录("数据库连接成功")
	
	sq结束时间 = form1.inputbox2.text
	
//	kongdang = (form1.ComboBox1.ListIndex+1) &"|"& form1.ComboBox1.List
	
	Call 导出程序(Form1.InputBox1.Text, sq结束时间)
	
	Call Plugin.SQLServer.Close()
	Call 日志记录("数据库断开连接")
End Event

//Event Form1.Button3.Click
//	MessageBox form1.ComboBox1.ListIndex
//End Event
//

Sub 导出程序(sq时间, sq结束时间) 

Call 日志记录("执行导出")

sq工号组 = Array("0st", "0bj", "0zz", "0q1")

//TracePrint 总空档名

//sq列表集合 = split(总空档名, "|")// 注意，第一个为当前选项位置,已+1,对应后续的选项
//
//sq选项 = sq列表集合(int(sq列表集合(0)))//////


For i = 0 to UBound(sq工号组)

	sqRet2 = 查询(sq工号组(i), sq时间, sq结束时间)
	
	If sqRet2 = "" Then 
		Goto sqpass
	End If

	//这两行顺序不可倒换 ------↓
	sq电话数组 = Split(sqRet2, "#")
//	Call 日志记录(sqRet2) 
	sqRet2 = left(sqRet2, Len(sqRet2) - 1)
	//这两行顺序不可倒换 ------↑
	
	sqtemp = split(sqRet2,"|")(2)
	
	Select Case sqtemp
		Case "6638580723" : sq选项 = "护腰"
		Case "6638580724" : sq选项 = "怡维康"
		Case "6638580725" : sq选项 = "长寿硒"
		Case "6638580726" : sq选项 = "特膳"
		Case "6638580727" : sq选项 = "护腰"
		Case "6638580728" : sq选项 = "助听器"
		Case "6638580729" : sq选项 = "骨关节"
		Case "6638580730" : sq选项 = "穆氏"
//		Case "6638580731" : sq选项 = ""
		Case "6638580732" : sq选项 = "奇方"
		Case "6638580733" : sq选项 = "关宁片"
		Case "6638580734" : sq选项 = "筑丽"
		Case "6638580735" : sq选项 = "乌发"
		Case "6638580736" : sq选项 = "健康"
		Case "6638580737" : sq选项 = "JQ"
		Case "6638580738" : sq选项 = "助听器"
		Case "6638580739" : sq选项 = "关宁片杂志"
		Case "6638580740" : sq选项 = "青钱柳"
		Case "6638580741" : sq选项 = "血糖"
//		Case "6638580742" : sq选项 = ""
		Case "6638580743" : sq选项 = "护膝"
//		Case "6638580744" : sq选项 = ""
		Case "6638580745" : sq选项 = "奶粉"
	End Select
//	If MsgBox("当前类别为："&sq选项&chr(13)&"当前数量为："&总数集合,1,"请确认") = 2 Then 
//		EndScript 
//	End If	
	
	Call 日志记录(Ubound(sq电话数组)&"通电话成功导出！")

	输出电话 = Replace(sqRet2, "#", Chr(13) & Chr(10))

	输出电话 = Replace(输出电话, "|", chr(9))
	
	输出电话 = "Column1	CallInTime	calledphone	ProName	CityName" & Chr(13) & Chr(10) & 输出电话
	
	iPath = Plugin.SysEx.GetDir(4)

//	If sq工号组(i) <> "0q1" Then 
	sq文件名 = iPath & "\"&LCase(Right(sq工号组(i),2)) & "-" & sq选项 & Ubound(sq电话数组)&".txt"
//	Else 
//		sq文件名 = iPath & "\"&LCase("旗舰"  & "-" & sq选项& Ubound(sq电话数组))&".txt"
//	End If
//	
	If Plugin.File.IsFileExist(sq文件名) Then 
		Call 日志记录("检测到重名文件，将做覆盖处理："&sq文件名)
		Call Plugin.File.ReNameFile(sq文件名,"bak."&sq文件名)
	End If
	
//	Call 日志记录("导出路径：" & sq文件名)
	
	call plugin.file.WriteFileEx(sq文件名, 输出电话)


	TracePrint Ubound(sq电话数组)
	Rem sqpass
Next

Call 日志记录("当前媒体为：===============>"&sq选项)
TracePrint sq选项 & "*************************************"

End Sub

Function 查询(工号, 开始时间, 结束时间)
	Call 日志记录("执行查询")
	
	b1 = "dbo.thing_LineIn as a left join dbo.info_City as b on a.PhoneCityID = b.CityID left join dbo.info_Province_Old as c on c.ProID = b.ProID"

	z2 = "dbo.DecTel(callphone),CallInTime,calledphone,ProName,CityName"

	tj = "AutoID in (select LineInID from dbo.thing_OrderBasicTemp where EmployeeID in (select EmployeeID from dbo.info_Employee where EmployeeNumber='"&工号&"')and PostTime > '"&开始时间&"' and PostTime < '"&结束时间&"')"
		
	查询 = Plugin.SQLServer.SelectData(b1, z2, tj)
	
End Function

Sub 日志记录(内容)
	Call Plugin.file.WriteFileEx("C:\Documents and Settings\Administrator\桌面\Export_log.txt", now()&"："&内容)
End Sub